<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>⛵</text></svg>">
<title>dev-ship dashboard</title>
<style>
  :root {
    --bg: #0d1117;
    --bg-surface: #161b22;
    --bg-hover: #1c2129;
    --border: #30363d;
    --text: #c9d1d9;
    --text-dim: #8b949e;
    --text-bright: #f0f6fc;
    --accent: #3fb950;
    --accent-dim: #238636;
    --red: #f85149;
    --blue: #58a6ff;
    --purple: #bc8cff;
    --mono: 'JetBrains Mono', 'Fira Code', 'Cascadia Code', 'SF Mono', 'Consolas', monospace;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: var(--mono);
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    font-size: 14px;
    line-height: 1.5;
  }

  .container {
    max-width: 960px;
    margin: 0 auto;
    padding: 24px 16px;
  }

  /* Header */
  header {
    margin-bottom: 32px;
    border-bottom: 1px solid var(--border);
    padding-bottom: 16px;
  }

  header h1 {
    font-size: 18px;
    font-weight: 600;
    color: var(--text-bright);
    letter-spacing: 0.5px;
  }

  header h1 span { color: var(--accent); }

  .connection-status {
    font-size: 11px;
    color: var(--text-dim);
    margin-top: 4px;
  }

  .connection-status .dot {
    display: inline-block;
    width: 6px;
    height: 6px;
    border-radius: 50%;
    margin-right: 4px;
    vertical-align: middle;
  }

  .dot-connected { background: var(--accent); }
  .dot-disconnected { background: var(--red); }

  /* Shared toolbar */
  .toolbar {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
  }

  .toolbar-search {
    flex: 1;
    background: var(--bg-surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 6px 12px;
    font-family: var(--mono);
    font-size: 12px;
    color: var(--text);
    outline: none;
    transition: border-color 0.15s;
  }

  .toolbar-search:focus { border-color: var(--blue); }
  .toolbar-search::placeholder { color: var(--text-dim); }

  .toolbar-select {
    background: var(--bg-surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 6px 12px;
    font-family: var(--mono);
    font-size: 12px;
    color: var(--text);
    cursor: pointer;
    outline: none;
  }

  .toolbar-select:focus { border-color: var(--blue); }

  /* Overview Table */
  .overview-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 16px;
  }

  .overview-table th {
    text-align: left;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--text-dim);
    padding: 8px 12px;
    border-bottom: 1px solid var(--border);
  }

  .overview-table tr.row {
    cursor: pointer;
    transition: background 0.15s;
  }

  .overview-table tr.row:hover { background: var(--bg-hover); }

  .overview-table td {
    padding: 10px 12px;
    border-bottom: 1px solid var(--border);
    font-size: 13px;
  }

  .status-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    padding: 2px 8px;
    border-radius: 12px;
    border: 1px solid;
  }

  .status-in-progress {
    color: var(--accent);
    border-color: var(--accent-dim);
    background: color-mix(in srgb, var(--accent) 10%, transparent);
  }

  .status-complete {
    color: var(--accent);
    border-color: var(--accent-dim);
    background: color-mix(in srgb, var(--accent) 10%, transparent);
  }

  .progress-bar {
    width: 80px;
    height: 6px;
    background: var(--border);
    border-radius: 3px;
    overflow: hidden;
    display: inline-block;
    vertical-align: middle;
    margin-right: 8px;
  }

  .progress-fill {
    height: 100%;
    border-radius: 3px;
    transition: width 0.3s ease;
  }

  .progress-fill-active { background: var(--accent); opacity: 0.7; }
  .progress-fill-done { background: var(--accent); }

  /* Detail View */
  .detail-view { display: none; }
  .detail-view.active { display: block; }
  .overview-view.hidden { display: none; }

  .back-btn {
    background: none;
    border: 1px solid var(--border);
    color: var(--text-dim);
    font-family: var(--mono);
    font-size: 12px;
    padding: 4px 12px;
    border-radius: 4px;
    cursor: pointer;
    margin-bottom: 20px;
    transition: all 0.15s;
  }

  .back-btn:hover {
    color: var(--text);
    border-color: var(--text-dim);
  }

  .detail-header { margin-bottom: 24px; }

  .detail-header h2 {
    font-size: 20px;
    color: var(--text-bright);
    margin-bottom: 4px;
  }

  .detail-meta {
    font-size: 12px;
    color: var(--text-dim);
  }

  .detail-meta span { margin-right: 16px; }

  /* Phase Timeline — Chevron Tracker */
  .timeline {
    display: flex;
    align-items: center;
    margin: 24px 0;
    overflow-x: auto;
    padding: 8px 0;
  }

  .timeline-phase {
    position: relative;
    flex-shrink: 0;
    min-width: 100px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0 24px;
    font-size: 12px;
    font-weight: 500;
    white-space: nowrap;
    clip-path: polygon(0 0, calc(100% - 12px) 0, 100% 50%, calc(100% - 12px) 100%, 0 100%, 12px 50%);
    margin-right: -6px;
  }

  .timeline-phase:first-child {
    clip-path: polygon(0 0, calc(100% - 12px) 0, 100% 50%, calc(100% - 12px) 100%, 0 100%);
  }

  .phase-done {
    background: var(--accent-dim);
    color: var(--accent);
  }

  .phase-active {
    background: var(--accent-dim);
    color: var(--text-bright);
    animation: chevron-pulse 2s infinite;
  }

  .phase-upcoming {
    background: var(--bg-surface);
    color: var(--text-dim);
  }

  @keyframes chevron-pulse {
    0%, 100% { filter: brightness(1); }
    50% { filter: brightness(1.3); }
  }

  /* Step Indicator */
  .step-indicator {
    padding: 16px;
    background: var(--bg-surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    margin-bottom: 16px;
  }

  .step-indicator h3 {
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--text-dim);
    margin-bottom: 12px;
  }

  .substeps {
    display: flex;
    gap: 24px;
  }

  .substep {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    color: var(--text-dim);
  }

  .substep-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--border);
    flex-shrink: 0;
  }

  .substep-done .substep-dot { background: var(--accent); }
  .substep-done { color: var(--accent); }

  .substep-active .substep-dot {
    background: var(--accent);
    animation: pulse-small 2s infinite;
  }
  .substep-active { color: var(--accent); font-weight: 600; }

  @keyframes pulse-small {
    0%, 100% { box-shadow: 0 0 0 0 color-mix(in srgb, var(--accent) 40%, transparent); }
    50% { box-shadow: 0 0 0 4px color-mix(in srgb, var(--accent) 0%, transparent); }
  }

  /* Sections */
  .section {
    margin-bottom: 16px;
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
  }

  .section-header {
    padding: 12px 16px;
    background: var(--bg-surface);
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--text-dim);
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    user-select: none;
  }

  .section-header:hover { color: var(--text); }

  .section-toggle { font-size: 10px; transition: transform 0.2s; }
  .section-toggle.open { transform: rotate(90deg); }

  .section-body {
    padding: 16px;
    display: none;
    font-size: 13px;
    line-height: 1.6;
  }

  .section-body.open { display: block; }

  .decision-entry {
    margin-bottom: 12px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--border);
  }

  .decision-entry:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }

  .decision-phase {
    font-size: 11px;
    color: var(--purple);
    margin-bottom: 4px;
  }

  .decision-text {
    color: var(--text);
  }

  .commit-hash {
    font-size: 11px;
    color: var(--purple);
    background: rgba(188, 140, 255, 0.1);
    padding: 2px 6px;
    border-radius: 4px;
  }

  .summary-text {
    color: var(--text);
    margin: 4px 0;
  }

  /* Backlog */
  .backlog-section {
    margin-top: 32px;
    border-top: 1px solid var(--border);
    padding-top: 24px;
  }

  .backlog-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
  }

  .backlog-header h2 {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-bright);
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .backlog-count {
    font-size: 11px;
    color: var(--text-dim);
  }

  /* backlog reuses .toolbar, .toolbar-search, .toolbar-select */

  .backlog-group {
    border: 1px solid var(--border);
    border-radius: 8px;
    margin-bottom: 8px;
    overflow: hidden;
  }

  .backlog-group-header {
    padding: 10px 16px;
    background: var(--bg-surface);
    font-size: 12px;
    font-weight: 600;
    color: var(--text);
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    user-select: none;
    transition: background 0.15s;
  }

  .backlog-group-header:hover { background: var(--bg-hover); }

  .backlog-group-body { display: none; }
  .backlog-group-body.open { display: block; }

  .backlog-group.completed-group { opacity: 0.7; }
  .backlog-group.completed-group .backlog-group-header { color: var(--text-dim); }

  .backlog-item {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    padding: 8px 16px;
    border-top: 1px solid var(--border);
    font-size: 13px;
    transition: background 0.15s;
  }

  .backlog-item:hover { background: var(--bg-hover); }

  .backlog-dot {
    flex-shrink: 0;
    width: 6px;
    height: 6px;
    border-radius: 50%;
    margin-top: 6px;
    background: var(--text-dim);
  }

  .backlog-dot-done {
    background: var(--accent);
  }

  .backlog-text { color: var(--text); flex: 1; }
  .backlog-text-done { color: var(--text-dim); text-decoration: line-through; }

  .backlog-date {
    font-size: 11px;
    color: var(--text-dim);
    flex-shrink: 0;
    margin-top: 2px;
  }

  .backlog-add {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
  }

  .add-btn {
    background: var(--accent-dim);
    border: 1px solid var(--accent);
    color: var(--accent);
    font-family: var(--mono);
    font-size: 14px;
    font-weight: 700;
    width: 36px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.15s;
    flex-shrink: 0;
  }

  .add-btn:hover { background: var(--accent); color: var(--bg); }

  .backlog-no-results {
    padding: 24px 16px;
    text-align: center;
    color: var(--text-dim);
    font-size: 13px;
  }

  /* Markdown rendering */
  .md-code {
    background: rgba(110, 118, 129, 0.2);
    padding: 1px 6px;
    border-radius: 4px;
    font-size: 12px;
    color: var(--text-bright);
  }

  .md-list {
    margin: 4px 0;
    padding-left: 20px;
  }

  .md-list li { margin-bottom: 4px; }
  .md-line { margin: 2px 0; }

  /* Settings Panel */
  .settings-btn {
    background: none;
    border: none;
    color: var(--text-dim);
    cursor: pointer;
    font-size: 16px;
    padding: 4px;
    line-height: 1;
    transition: color 0.15s;
  }

  .settings-btn:hover { color: var(--text); }

  .settings-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 100;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.2s, visibility 0.2s;
  }

  .settings-overlay.open {
    opacity: 1;
    visibility: visible;
  }

  .settings-panel {
    position: fixed;
    top: 0;
    right: 0;
    bottom: 0;
    width: 280px;
    background: var(--bg-surface);
    border-left: 1px solid var(--border);
    z-index: 101;
    transform: translateX(100%);
    transition: transform 0.25s ease;
    padding: 24px;
    display: flex;
    flex-direction: column;
  }

  .settings-overlay.open .settings-panel {
    transform: translateX(0);
  }

  .settings-panel h3 {
    font-size: 14px;
    color: var(--text-bright);
    margin-bottom: 20px;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .settings-label {
    font-size: 11px;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 8px;
  }

  .color-swatches {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 16px;
  }

  .color-swatch {
    width: 32px;
    height: 32px;
    border-radius: 6px;
    border: 2px solid transparent;
    cursor: pointer;
    transition: border-color 0.15s, transform 0.15s;
  }

  .color-swatch:hover { transform: scale(1.1); }
  .color-swatch.selected { border-color: var(--text-bright); }

  .custom-color-row {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 24px;
  }

  .custom-color-input {
    width: 40px;
    height: 32px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    background: none;
    padding: 0;
  }

  .custom-color-input::-webkit-color-swatch-wrapper { padding: 0; }
  .custom-color-input::-webkit-color-swatch { border: 1px solid var(--border); border-radius: 4px; }

  .custom-color-label {
    font-size: 12px;
    color: var(--text-dim);
  }

  .settings-save {
    background: var(--accent-dim);
    border: 1px solid var(--accent);
    color: var(--accent);
    font-family: var(--mono);
    font-size: 12px;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.15s;
    margin-top: auto;
  }

  .settings-save:hover { background: var(--accent); color: var(--bg); }

  /* Empty state */
  .empty-state {
    text-align: center;
    padding: 48px 16px;
    color: var(--text-dim);
  }

  .empty-state p { margin-top: 8px; font-size: 13px; }
</style>
</head>
<body>
<div class="container">
  <header style="display: flex; justify-content: space-between; align-items: flex-start;">
    <div>
      <h1><span>&gt;</span> <span id="projectName">dev-ship</span> <span style="color: var(--text-dim); font-weight: 400">dashboard</span></h1>
      <div class="connection-status">
        <span class="dot dot-disconnected" id="connDot"></span>
        <span id="connText">connecting...</span>
      </div>
    </div>
    <button class="settings-btn" id="settingsBtn" title="Settings">&#9881;</button>
  </header>

  <div class="settings-overlay" id="settingsOverlay">
    <div class="settings-panel" id="settingsPanel">
      <h3>Settings</h3>
      <div class="settings-label">Accent Color</div>
      <div class="color-swatches" id="colorSwatches"></div>
      <div class="custom-color-row">
        <input type="color" class="custom-color-input" id="customColor" value="#3fb950" />
        <span class="custom-color-label">Custom</span>
      </div>
      <button class="settings-save" id="settingsSave">Save</button>
    </div>
  </div>

  <div class="overview-view" id="overviewView">
    <div class="toolbar">
      <input type="text" id="featureSearch" class="toolbar-search" placeholder="Search features..." />
      <select id="featureFilter" class="toolbar-select">
        <option value="all">All</option>
        <option value="active">Active</option>
        <option value="complete">Complete</option>
      </select>
    </div>
    <table class="overview-table">
      <thead>
        <tr>
          <th>Feature</th>
          <th>Ticket</th>
          <th>Step</th>
          <th>Progress</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="featureTable"></tbody>
    </table>
    <div class="empty-state" id="emptyState" style="display:none">
      <div style="font-size:24px; opacity:0.5">~</div>
      <p>No features yet. Run /dev-ship:sail to start one.</p>
    </div>
    <div class="backlog-section" id="backlogSection" style="display:none">
      <div class="backlog-header">
        <h2>Backlog</h2>
        <span class="backlog-count" id="backlogCount"></span>
      </div>
      <div class="toolbar">
        <input type="text" id="backlogSearch" class="toolbar-search" placeholder="Search backlog..." />
        <select id="backlogSort" class="toolbar-select">
          <option value="newest">Newest first</option>
          <option value="oldest">Oldest first</option>
          <option value="alpha">A &rarr; Z</option>
        </select>
      </div>
      <div class="backlog-add">
        <select id="backlogAddSection" class="toolbar-select"></select>
        <input type="text" id="backlogAddText" class="toolbar-search" placeholder="Add to backlog..." />
        <button id="backlogAddBtn" class="add-btn">+</button>
      </div>
      <div id="backlogGroups"></div>
      <div id="backlogCompleted"></div>
    </div>
  </div>

  <div class="detail-view" id="detailView">
    <button class="back-btn" id="backBtn">&lt;-- back</button>
    <div class="detail-header">
      <h2 id="detailName"></h2>
      <div class="detail-meta">
        <span id="detailStarted"></span>
        <span id="detailTicket"></span>
      </div>
    </div>
    <div id="detailTimeline" class="timeline"></div>
    <div id="detailStepIndicator" class="step-indicator"></div>
    <div id="detailSections"></div>
  </div>
</div>

<script>
  let features = [];
  let backlog = { sections: [] };
  let currentDetail = null;
  let projectName = null;

  document.getElementById('backBtn').addEventListener('click', () => navigate('/'));

  // --- DOM Helpers ---
  function el(tag, attrs, children) {
    const e = document.createElement(tag);
    if (attrs) {
      for (const [k, v] of Object.entries(attrs)) {
        if (k === 'className') e.className = v;
        else if (k === 'style') Object.assign(e.style, v);
        else if (k.startsWith('on')) e.addEventListener(k.slice(2), v);
        else e.setAttribute(k, v);
      }
    }
    if (children) {
      for (const c of Array.isArray(children) ? children : [children]) {
        if (typeof c === 'string') e.appendChild(document.createTextNode(c));
        else if (c) e.appendChild(c);
      }
    }
    return e;
  }

  // --- Markdown Rendering ---
  function renderInlineMd(text) {
    const frag = document.createDocumentFragment();
    const re = /\*\*(.+?)\*\*|`(.+?)`|\*(.+?)\*/g;
    let last = 0, m;
    while ((m = re.exec(text)) !== null) {
      if (m.index > last) frag.appendChild(document.createTextNode(text.slice(last, m.index)));
      if (m[1]) frag.appendChild(el('strong', { style: { color: 'var(--text-bright)' } }, [m[1]]));
      else if (m[2]) frag.appendChild(el('code', { className: 'md-code' }, [m[2]]));
      else if (m[3]) frag.appendChild(el('em', null, [m[3]]));
      last = m.index + m[0].length;
    }
    if (last < text.length) frag.appendChild(document.createTextNode(text.slice(last)));
    return frag;
  }

  function renderMdBlock(text) {
    const frag = document.createDocumentFragment();
    const lines = text.split('\n');
    let i = 0;
    while (i < lines.length) {
      if (!lines[i].trim()) { i++; continue; }
      if (/^\s*[-*] /.test(lines[i])) {
        const ul = document.createElement('ul');
        ul.className = 'md-list';
        while (i < lines.length && /^\s*[-*] /.test(lines[i])) {
          const li = document.createElement('li');
          li.appendChild(renderInlineMd(lines[i].replace(/^\s*[-*] /, '')));
          while (i + 1 < lines.length && /^\s{2,}/.test(lines[i + 1]) && !/^\s*[-*] /.test(lines[i + 1])) {
            i++;
            li.appendChild(document.createElement('br'));
            li.appendChild(renderInlineMd(lines[i].trim()));
          }
          ul.appendChild(li);
          i++;
        }
        frag.appendChild(ul);
      } else if (/^\s*\d+\.\s/.test(lines[i])) {
        const ol = document.createElement('ol');
        ol.className = 'md-list';
        while (i < lines.length && /^\s*\d+\.\s/.test(lines[i])) {
          const li = document.createElement('li');
          li.appendChild(renderInlineMd(lines[i].replace(/^\s*\d+\.\s/, '')));
          ol.appendChild(li);
          i++;
        }
        frag.appendChild(ol);
      } else {
        const div = document.createElement('div');
        div.className = 'md-line';
        div.appendChild(renderInlineMd(lines[i]));
        frag.appendChild(div);
        i++;
      }
    }
    return frag;
  }

  // --- SSE Connection ---
  function connectSSE() {
    const es = new EventSource('/events');
    es.onmessage = (e) => {
      const data = JSON.parse(e.data);
      if (data.type === 'reload') { location.reload(); return; }
      if (data.project && !projectName) {
        projectName = data.project;
        document.title = data.project + ' — dev-ship';
        document.getElementById('projectName').textContent = data.project;
      }
      features = data.features || [];
      backlog = data.backlog || { sections: [] };
      if (data.settings) applySettings(data.settings);
      renderOverview();
      renderBacklog();
      if (currentDetail) refreshDetail(currentDetail);
    };
    es.onopen = () => {
      document.getElementById('connDot').className = 'dot dot-connected';
      document.getElementById('connText').textContent = 'live';
    };
    es.onerror = () => {
      document.getElementById('connDot').className = 'dot dot-disconnected';
      document.getElementById('connText').textContent = 'reconnecting...';
    };
  }

  // --- Overview ---
  function renderOverview() {
    const tbody = document.getElementById('featureTable');
    const empty = document.getElementById('emptyState');
    const query = (document.getElementById('featureSearch').value || '').toLowerCase();
    const filter = document.getElementById('featureFilter').value;

    tbody.replaceChildren();

    const filtered = features.filter(f => {
      if (query && !(f.name || f.dir).toLowerCase().includes(query)
          && !(f.ticket || '').toLowerCase().includes(query)
          && !(f.step || '').toLowerCase().includes(query)) return false;
      if (filter === 'active' && f.status === 'complete') return false;
      if (filter === 'complete' && f.status !== 'complete') return false;
      return true;
    });

    if (features.length === 0) {
      empty.style.display = 'block';
      return;
    }

    empty.style.display = 'none';

    if (filtered.length === 0 && query) {
      tbody.appendChild(el('tr', null, [
        el('td', { colspan: '5', style: { textAlign: 'center', color: 'var(--text-dim)', padding: '24px' } },
          ['No features match "' + query + '"']),
      ]));
      return;
    }

    if (filtered.length === 0 && filter !== 'all') {
      tbody.appendChild(el('tr', null, [
        el('td', { colspan: '5', style: { textAlign: 'center', color: 'var(--text-dim)', padding: '24px' } },
          ['No ' + filter + ' features']),
      ]));
      return;
    }

    for (const f of filtered) {
      const pct = f.phasesTotal ? Math.round((f.phasesComplete / f.phasesTotal) * 100) : 0;
      const isDone = f.status === 'complete';

      const row = el('tr', { className: 'row', onclick: () => navigate('/feature/' + encodeURIComponent(f.dir)) }, [
        el('td', { style: { color: 'var(--text-bright)' } }, [f.name || f.dir]),
        el('td', { style: { color: 'var(--text-dim)' } }, [f.ticket || 'none']),
        el('td', null, [f.step || '\u2014']),
        el('td', null, [
          (() => {
            const bar = el('div', { className: 'progress-bar' });
            const fill = el('div', {
              className: 'progress-fill ' + (isDone ? 'progress-fill-done' : 'progress-fill-active'),
            });
            fill.style.width = pct + '%';
            bar.appendChild(fill);
            return bar;
          })(),
          el('span', { style: { fontSize: '11px', color: 'var(--text-dim)' } }, [
            f.phasesTotal ? `${f.phasesComplete}/${f.phasesTotal}` : '0/?',
          ]),
        ]),
        el('td', null, [
          el('span', {
            className: 'status-badge ' + (isDone ? 'status-complete' : 'status-in-progress'),
          }, [isDone ? '\u2713 complete' : '\u25cf active']),
        ]),
      ]);

      tbody.appendChild(row);
    }
  }

  // --- Backlog ---
  function renderBacklog() {
    const sectionEl = document.getElementById('backlogSection');
    const groupsEl = document.getElementById('backlogGroups');
    const completedEl = document.getElementById('backlogCompleted');
    const countEl = document.getElementById('backlogCount');
    const query = (document.getElementById('backlogSearch').value || '').toLowerCase();
    const sortMode = document.getElementById('backlogSort').value;

    groupsEl.replaceChildren();
    completedEl.replaceChildren();

    const sections = backlog.sections || [];
    sectionEl.style.display = 'block';
    updateSectionDropdown();

    const hasItems = sections.some(s => s.items.length > 0);
    if (!hasItems) {
      countEl.textContent = 'empty';
      return;
    }

    let totalOpen = 0, totalDone = 0;
    for (const s of sections) {
      for (const item of s.items) { item.done ? totalDone++ : totalOpen++; }
    }
    countEl.textContent = totalOpen + ' open' + (totalDone ? ', ' + totalDone + ' done' : '');

    function sortItems(items) {
      return [...items].sort((a, b) => {
        if (sortMode === 'newest') return (b.added || '').localeCompare(a.added || '');
        if (sortMode === 'oldest') return (a.added || '').localeCompare(b.added || '');
        return a.text.localeCompare(b.text);
      });
    }

    function matchesSearch(item) {
      return !query || item.text.toLowerCase().includes(query);
    }

    // Open items grouped by section
    let hasVisible = false;
    for (const s of sections) {
      const openItems = sortItems(s.items.filter(i => !i.done && matchesSearch(i)));
      if (openItems.length === 0) continue;
      hasVisible = true;
      groupsEl.appendChild(buildBacklogGroup(s.name, openItems, true, false));
    }

    // Completed items in separate collapsed section
    const allDone = [];
    for (const s of sections) {
      allDone.push(...s.items.filter(i => i.done && matchesSearch(i)));
    }
    if (allDone.length > 0) {
      hasVisible = true;
      completedEl.appendChild(buildBacklogGroup(
        'Completed (' + allDone.length + ')', sortItems(allDone), false, true
      ));
    }

    if (!hasVisible && query) {
      groupsEl.appendChild(el('div', { className: 'backlog-no-results' }, ['No items match "' + query + '"']));
    }
  }

  function buildBacklogGroup(name, items, startOpen, isCompleted) {
    const group = el('div', { className: 'backlog-group' + (isCompleted ? ' completed-group' : '') });
    const toggle = el('span', { className: 'section-toggle' + (startOpen ? ' open' : '') }, ['\u25b6']);
    const header = el('div', { className: 'backlog-group-header' }, [name, toggle]);
    const body = el('div', { className: 'backlog-group-body' + (startOpen ? ' open' : '') });

    for (const item of items) {
      const dot = el('div', {
        className: 'backlog-dot' + (item.done ? ' backlog-dot-done' : ''),
      });

      const textEl = el('span', {
        className: 'backlog-text' + (item.done ? ' backlog-text-done' : ''),
      });
      textEl.appendChild(renderInlineMd(item.text));

      const children = [dot, textEl];
      if (item.added) {
        children.push(el('span', { className: 'backlog-date' }, [item.added]));
      }
      body.appendChild(el('div', { className: 'backlog-item' }, children));
    }

    header.addEventListener('click', () => {
      toggle.classList.toggle('open');
      body.classList.toggle('open');
    });

    group.appendChild(header);
    group.appendChild(body);
    return group;
  }

  // --- Backlog Add ---
  function updateSectionDropdown() {
    const select = document.getElementById('backlogAddSection');
    const current = select.value;
    const sections = (backlog.sections || []).map(s => s.name);
    select.replaceChildren();
    for (const name of sections) {
      select.appendChild(el('option', { value: name }, [name]));
    }
    if (current && sections.includes(current)) select.value = current;
  }

  async function addBacklogItem() {
    const textInput = document.getElementById('backlogAddText');
    const sectionSelect = document.getElementById('backlogAddSection');
    const text = textInput.value.trim();
    if (!text) return;

    const section = sectionSelect.value;

    try {
      const res = await fetch('/api/backlog', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text, section }),
      });
      if (res.ok) textInput.value = '';
    } catch (e) { /* SSE will refresh the UI */ }
  }

  document.getElementById('backlogAddBtn').addEventListener('click', addBacklogItem);
  document.getElementById('backlogAddText').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') addBacklogItem();
  });

  // --- Router ---
  function navigate(path) {
    history.pushState(null, '', path);
    handleRoute();
  }

  function handleRoute() {
    const path = location.pathname;
    const featureMatch = path.match(/^\/feature\/([^/]+)$/);

    if (featureMatch) {
      const name = decodeURIComponent(featureMatch[1]);
      currentDetail = name;
      document.getElementById('overviewView').classList.add('hidden');
      document.getElementById('detailView').classList.add('active');
      fetchDetail(name);
    } else {
      currentDetail = null;
      document.getElementById('overviewView').classList.remove('hidden');
      document.getElementById('detailView').classList.remove('active');
    }

    // Update page title
    if (currentDetail && projectName) {
      document.title = currentDetail + ' — ' + projectName + ' — dev-ship';
    } else if (projectName) {
      document.title = projectName + ' — dev-ship';
    }
  }

  window.addEventListener('popstate', handleRoute);

  // --- Detail View ---
  async function fetchDetail(name) {
    try {
      const res = await fetch('/api/features/' + encodeURIComponent(name));
      if (res.ok) renderDetail(await res.json());
    } catch (e) { /* ignore fetch errors */ }
  }

  async function refreshDetail(name) {
    try {
      const res = await fetch('/api/features/' + encodeURIComponent(name));
      if (res.ok) renderDetail(await res.json());
    } catch (e) { /* ignore refresh errors */ }
  }

  function renderDetail(d) {
    document.getElementById('detailName').textContent = d.name || d.dir;
    document.getElementById('detailStarted').textContent = 'started: ' + (d.started || '\u2014');
    document.getElementById('detailTicket').textContent =
      d.ticket && d.ticket !== 'none' ? 'ticket: ' + d.ticket : '';

    renderTimeline(d);
    renderStepIndicator(d);
    renderSections(d);
  }

  function renderTimeline(d) {
    const container = document.getElementById('detailTimeline');
    container.replaceChildren();

    if (!d.phasesTotal) {
      container.appendChild(el('span', {
        style: { color: 'var(--text-dim)', fontSize: '12px' },
      }, ['No phases defined yet']));
      return;
    }

    const currentPhase = parseCurrentPhase(d.step);

    let activeEl = null;

    for (let i = 1; i <= d.phasesTotal; i++) {
      const isDone = i <= d.phasesComplete;
      const isActive = i === currentPhase;
      const stateClass = isDone ? 'phase-done' : isActive ? 'phase-active' : 'phase-upcoming';
      const phaseName = getPhaseLabel(d, i);

      const phaseEl = el('div', { className: 'timeline-phase ' + stateClass }, [phaseName]);
      if (isActive) activeEl = phaseEl;
      container.appendChild(phaseEl);
    }

    if (activeEl) {
      activeEl.scrollIntoView({ inline: 'center', block: 'nearest' });
    }
  }

  function renderStepIndicator(d) {
    const container = document.getElementById('detailStepIndicator');
    container.replaceChildren();

    const currentPhase = parseCurrentPhase(d.step);
    const currentSub = parseSubStep(d.step);

    if (d.status === 'complete') {
      container.appendChild(el('h3', null, ['Current Step']));
      container.appendChild(el('div', {
        style: { color: 'var(--accent)', fontSize: '13px' },
      }, ['\u2713 All phases complete']));
      return;
    }

    if (!currentPhase) {
      container.appendChild(el('h3', null, ['Current Step']));
      const steps = el('div', { className: 'substeps' });
      steps.appendChild(el('div', { className: 'substep substep-active' }, [
        el('div', { className: 'substep-dot' }),
        d.step || 'unknown',
      ]));
      container.appendChild(steps);
      return;
    }

    container.appendChild(el('h3', null, ['Phase ' + currentPhase + ' \u2014 Current Step']));

    const substeps = ['context', 'implement', 'summarize'];
    const subIdx = substeps.indexOf(currentSub);
    const stepsDiv = el('div', { className: 'substeps' });

    for (let i = 0; i < substeps.length; i++) {
      const cls = i < subIdx ? 'substep substep-done' : i === subIdx ? 'substep substep-active' : 'substep';
      stepsDiv.appendChild(el('div', { className: cls }, [
        el('div', { className: 'substep-dot' }),
        substeps[i],
      ]));
    }

    container.appendChild(stepsDiv);
  }

  function renderSections(d) {
    const container = document.getElementById('detailSections');
    container.replaceChildren();

    // Decision log
    if (d.phases && d.phases.length > 0) {
      const decisions = d.phases
        .filter(p => p.context)
        .map(p => {
          const m = p.context.match(/## Decisions\n([\s\S]*?)(?=\n## |$)/);
          return { number: p.number, text: m ? m[1].trim() : null };
        })
        .filter(p => p.text);

      if (decisions.length > 0) {
        container.appendChild(buildSection('Decisions', decisions.map(dec => {
          const entry = el('div', { className: 'decision-entry' }, [
            el('div', { className: 'decision-phase' }, ['Phase ' + dec.number]),
            (() => { const d = el('div', { className: 'decision-text' }); d.appendChild(renderMdBlock(dec.text)); return d; })(),
          ]);
          return entry;
        }), true));
      }
    }

    // Files & commits
    if (d.phases && d.phases.length > 0) {
      const summaries = d.phases
        .filter(p => p.summary)
        .map(p => {
          const filesMatch = p.summary.match(/## Files changed\n([\s\S]*?)(?=\n## |$)/);
          const commitMatch = p.summary.match(/## Commit\n([\s\S]*?)(?=\n## |$)/);
          return {
            number: p.number,
            files: filesMatch ? filesMatch[1].trim() : null,
            commit: commitMatch ? commitMatch[1].trim() : null,
          };
        })
        .filter(p => p.files || p.commit);

      if (summaries.length > 0) {
        container.appendChild(buildSection('Files & Commits', summaries.map(s => {
          const children = [el('div', { className: 'decision-phase' }, ['Phase ' + s.number])];
          if (s.files) { const fd = el('div', { className: 'summary-text' }); fd.appendChild(renderMdBlock(s.files)); children.push(fd); }
          if (s.commit) children.push(el('div', null, [el('span', { className: 'commit-hash' }, [s.commit])]));
          return el('div', { className: 'decision-entry' }, children);
        }), false));
      }
    }
  }

  function buildSection(title, entries, startOpen) {
    const section = el('div', { className: 'section' });

    const toggle = el('span', { className: 'section-toggle' + (startOpen ? ' open' : '') }, ['\u25b6']);
    const header = el('div', { className: 'section-header' }, [title, toggle]);
    const body = el('div', { className: 'section-body' + (startOpen ? ' open' : '') });

    for (const entry of entries) body.appendChild(entry);

    header.addEventListener('click', () => {
      toggle.classList.toggle('open');
      body.classList.toggle('open');
    });

    section.appendChild(header);
    section.appendChild(body);
    return section;
  }

  // --- Helpers ---
  function parseCurrentPhase(step) {
    if (!step) return null;
    const m = step.match(/^phase-(\d+)/);
    return m ? parseInt(m[1], 10) : null;
  }

  function parseSubStep(step) {
    if (!step) return null;
    const m = step.match(/^phase-\d+:(\w+)/);
    return m ? m[1] : null;
  }

  function getPhaseLabel(d, num) {
    if (!d.plan) return 'Phase ' + num;
    const m = d.plan.match(new RegExp('### Phase ' + num + ':\\s*(.+)'));
    return m ? m[1].trim() : 'Phase ' + num;
  }

  // --- Settings ---
  const PRESET_COLORS = [
    { name: 'Green',  hex: '#3fb950' },
    { name: 'Blue',   hex: '#58a6ff' },
    { name: 'Purple', hex: '#bc8cff' },
    { name: 'Amber',  hex: '#d29922' },
    { name: 'Rose',   hex: '#f778ba' },
    { name: 'Teal',   hex: '#2dd4bf' },
    { name: 'Orange', hex: '#f0883e' },
    { name: 'Red',    hex: '#f85149' },
  ];

  let pendingAccent = null;

  function initSwatches() {
    const container = document.getElementById('colorSwatches');
    for (const color of PRESET_COLORS) {
      const swatch = el('div', {
        className: 'color-swatch',
        title: color.name,
        style: { background: color.hex },
        onclick: () => selectColor(color.hex),
      });
      swatch.dataset.color = color.hex;
      container.appendChild(swatch);
    }
  }

  function selectColor(hex) {
    pendingAccent = hex;
    document.getElementById('customColor').value = hex;
    document.querySelectorAll('.color-swatch').forEach(s => {
      s.classList.toggle('selected', s.dataset.color === hex);
    });
    applyAccentColor(hex);
  }

  function dimColor(hex) {
    const r = parseInt(hex.slice(1, 3), 16);
    const g = parseInt(hex.slice(3, 5), 16);
    const b = parseInt(hex.slice(5, 7), 16);
    return '#' + [r, g, b].map(c => Math.round(c * 0.55).toString(16).padStart(2, '0')).join('');
  }

  function applyAccentColor(hex) {
    const root = document.documentElement;
    root.style.setProperty('--accent', hex);
    root.style.setProperty('--accent-dim', dimColor(hex));
  }

  function applySettings(settings) {
    if (settings && settings.accentColor) {
      applyAccentColor(settings.accentColor);
      pendingAccent = settings.accentColor;
      document.getElementById('customColor').value = settings.accentColor;
      document.querySelectorAll('.color-swatch').forEach(s => {
        s.classList.toggle('selected', s.dataset.color === settings.accentColor);
      });
    }
  }

  async function saveSettings() {
    if (!pendingAccent) return;
    try {
      await fetch('/api/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ accentColor: pendingAccent }),
      });
    } catch (e) { /* will sync via SSE */ }
    closeSettings();
  }

  function openSettings() {
    document.getElementById('settingsOverlay').classList.add('open');
  }

  function closeSettings() {
    document.getElementById('settingsOverlay').classList.remove('open');
  }

  document.getElementById('settingsBtn').addEventListener('click', openSettings);
  document.getElementById('settingsSave').addEventListener('click', saveSettings);
  document.getElementById('settingsOverlay').addEventListener('click', (e) => {
    if (e.target === document.getElementById('settingsOverlay')) closeSettings();
  });
  document.getElementById('customColor').addEventListener('input', (e) => {
    const hex = e.target.value;
    pendingAccent = hex;
    document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('selected'));
    applyAccentColor(hex);
  });

  initSwatches();

  // --- Init ---
  document.getElementById('featureSearch').addEventListener('input', renderOverview);
  document.getElementById('featureFilter').addEventListener('change', renderOverview);
  document.getElementById('backlogSearch').addEventListener('input', renderBacklog);
  document.getElementById('backlogSort').addEventListener('change', renderBacklog);
  handleRoute(); // Route on initial page load
  connectSSE();
</script>
</body>
</html>
